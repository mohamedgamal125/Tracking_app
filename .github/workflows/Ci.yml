name: CI

on: [ push, pull_request ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'

      - name: Install dependencies
        run: flutter pub get


      - name: Run tests with coverage
        run: flutter test --coverage


      - name: Format coverage report
        run: |
          dart run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/lcov.info \
            --report-on lib \
            --check-ignore \
            --base-directory .

      - name: Calculate and enforce â‰¥80% coverage
        run: |
            total=$(grep -c '^DA:' coverage/lcov.info || echo 0)
            covered=$(grep -E '^DA:[0-9]+,[1-9]' coverage/lcov.info | wc -l || echo 0)
            echo "Total lines: ${total}"
            echo "Covered lines: ${covered}"
            if [[ $total -eq 0 ]]; then
              echo "::warning::No executable lines found (skipping)."
              exit 0
            fi
            percent=$(( covered * 100 / total ))
            echo "Coverage: ${percent}%"
            if (( percent < 80 )); then
              echo "::error::Coverage below 80% (${percent}%)."
              exit 1
            fi