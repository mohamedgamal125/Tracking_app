name: CI

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'

      - name: Install dependencies
        run: flutter pub get


      - name: Activate coverage package
        run: |
          dart pub global activate coverage
          echo "::add-path::$HOME/.pub-cache/bin"
      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Format coverage report
        run: |
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/lcov.info \
            --check-ignore \
            --base-directory .

      - name: Enforce â‰¥80% coverage
        run: |
          percent=$(grep -Po '(?<=^LF:)\d+' coverage/lcov.info | head -1)
          echo "Coverage: ${percent}%"
          if (( percent < 80 )); then
            echo "::error::Line coverage is below 80% (${percent}%)"
            exit 1
          fi
